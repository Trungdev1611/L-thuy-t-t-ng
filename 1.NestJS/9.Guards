# Guards dÃ¹ng Ä‘á»ƒ tÃ¹y chá»‰nh cháº·n/ hoáº·c cho phÃ©p viá»‡c truy cáº­p router vÃ  phÃ¢n quyá»n truy cáº­p route
 (thay vÃ¬ sá»­ dá»¥ng middleware nhÆ° express).  Nestjs cÅ©ng cÃ³ middleware nhÆ°ng Guards Ä‘Æ°á»£c sá»­ dá»¥ng phÃ¢n quyá»n chuáº©n hÆ¡n


  Guard: RolesGuard.ts
  import {
  CanActivate,
  ExecutionContext,
  Injectable,
} from '@nestjs/common';
import { Reflector } from '@nestjs/core';

@Injectable()
export class RolesGuard implements CanActivate {
  constructor(private reflector: Reflector) {}

  canActivate(context: ExecutionContext): boolean {
    // ğŸ‘‡ Gá»i handler vÃ  class hiá»‡n táº¡i
    const handler = context.getHandler();
    const controller = context.getClass();

    // ğŸ‘‡ In ra console Ä‘á»ƒ báº¡n tháº¥y
    console.log('Handler (method):', handler.name);
    console.log('Controller (class):', controller.name);

    // ğŸ‘‡ Láº¥y metadata 'roles' gÃ¡n tá»« @Roles() á»Ÿ method hoáº·c class
    const requiredRoles = this.reflector.getAllAndOverride<string[]>('roles', [
      handler,
      controller,
    ]);
    console.log('Required Roles:', requiredRoles);

    if (!requiredRoles) {
      // Náº¿u route nÃ y khÃ´ng yÃªu cáº§u role cá»¥ thá»ƒ â†’ cho phÃ©p truy cáº­p
      return true;
    }

    // ğŸ‘‡ Láº¥y user tá»« request (Ä‘Æ°á»£c set sáºµn bá»Ÿi AuthGuard hoáº·c middleware)
    const request = context.switchToHttp().getRequest();
    const user = request.user;

    console.log('Current User Role:', user?.role);

    // ğŸ‘‡ So sÃ¡nh user.role vá»›i requiredRoles
    return requiredRoles.includes(user?.role);
  }
}


Decorator: roles.decorator.ts
import { SetMetadata } from '@nestjs/common';

export const ROLES_KEY = 'roles';

export const Roles = (...roles: string[]) => SetMetadata(ROLES_KEY, roles);

ğŸ‘¨â€ğŸ« Controller Example: users.controller.ts
import { Controller, Get, UseGuards } from '@nestjs/common';
import { Roles } from './roles.decorator';
import { RolesGuard } from './roles.guard';

@Controller('users')
@UseGuards(RolesGuard)
export class UsersController {
  @Get()
  @Roles('admin', 'manager')
  findAll() {
    return ['user1', 'user2'];
  }
}


 Káº¿t quáº£ khi gá»i GET /users
Giáº£ sá»­ request.user = { role: 'admin' }, báº¡n sáº½ tháº¥y trong console:

Handler (method): findAll
Controller (class): UsersController
Required Roles: [ 'admin', 'manager' ]
Current User Role: admin